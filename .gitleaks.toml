# Gitleaks configuration for eCortex
# This config excludes upstream MeshCentral sample files and focuses on deploy/ secrets

title = "eCortex Gitleaks Config"

# =============================================================================
# Path Exclusions - Upstream MeshCentral files with intentional placeholders
# =============================================================================
[allowlist]
description = "Allowlist for upstream MeshCentral files"

# Exclude paths that are part of upstream MeshCentral (not our deploy code)
paths = [
    # Upstream sample configs with placeholder passwords
    '''sample-config.*\.json''',
    '''sample-config-advanced\.json''',
    
    # Upstream Docker examples
    '''docker/compose\.yaml''',
    '''docker/config\.json\.template''',
    
    # Upstream agent and module files
    '''agents/.*''',
    '''amt/.*''',
    '''rdp/.*''',
    '''public/.*''',
    '''views/.*''',
    '''emails/.*''',
    
    # Upstream source files that handle keys/certs (not actual secrets)
    '''authenticode\.js''',
    '''certoperations\.js''',
    '''pkcs7-modified\.js''',
    '''webauthn\.js''',
    '''letsencrypt\.js''',
    
    # Test and documentation files
    '''docs/.*''',
    '''translate/.*''',
    
    # Our template files (contain PLACEHOLDER values intentionally)
    '''deploy/.*\.template''',
    '''deploy/env\.example''',
    
    # Git and CI files
    '''\.github/.*''',
    '''\.gitignore''',
]

# Regex patterns to allow (common false positives)
regexes = [
    # Placeholder patterns we use
    '''PLACEHOLDER''',
    '''CHANGE_ME''',
    '''your-.*-here''',
    '''example\.com''',
    '''cortalis\.com''',
    
    # Upstream MeshCentral example credentials (intentionally fake)
    '''mongodb://username:password@''',
    '''mongodb://127\.0\.0\.1:27017''',
    '''password123''',
    '''admin:admin''',
]

# =============================================================================
# Rule Overrides - Fine-tune detection
# =============================================================================

# Don't flag base64-looking strings in agent binaries
[[rules]]
id = "generic-api-key"
description = "Generic API Key"
regex = '''(?i)(?:api[_-]?key|apikey)[\s]*[=:]+[\s]*['"]([\w-]{20,})['"']'''
allowlist = { paths = ['''agents/.*''', '''public/.*'''] }

# MongoDB connection strings - only flag if they look like real credentials
[[rules]]
id = "mongodb-connection"
description = "MongoDB Connection String"
regex = '''mongodb(?:\+srv)?://[^:]+:[^@]+@[^/]+'''
allowlist = { 
    paths = ['''sample-.*''', '''docker/.*''', '''\.template$'''],
    regexes = ['''username:password''', '''PLACEHOLDER''', '''127\.0\.0\.1''']
}

# Session keys - exclude placeholders
[[rules]]
id = "session-key"
description = "Session Key"
regex = '''(?i)session[_-]?key[\s]*[=:]+[\s]*['"]([\w-]{20,})['"']'''
allowlist = { regexes = ['''PLACEHOLDER''', '''CHANGE_ME'''] }
