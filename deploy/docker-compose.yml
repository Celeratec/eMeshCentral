# eCortex Production Deployment - Cortalis Backup Remote Access
# This deployment uses Traefik as reverse proxy with Let's Encrypt TLS
# All data persists in named volumes - survives container restarts
#
# IMPORTANT: Copy .env.example to .env and configure before deployment

services:
  # =============================================================================
  # TRAEFIK - Reverse Proxy with automatic TLS
  # =============================================================================
  traefik:
    image: traefik:v3.0
    container_name: meshcentral-traefik
    restart: unless-stopped
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=meshcentral-network"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Logging
      - "--log.level=WARN"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt
      - traefik-logs:/var/log/traefik
    networks:
      - meshcentral-network
    labels:
      # Dashboard (optional - disable in production if not needed)
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=traefik-auth"
      # Basic auth for dashboard - generate with: htpasswd -nb admin <password>
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
      # Rate limiting middleware
      - "traefik.http.middlewares.ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.ratelimit.ratelimit.burst=50"
      # Security headers middleware
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # MONGODB - Database for eCortex
  # =============================================================================
  mongodb:
    image: mongo:7
    container_name: meshcentral-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: meshcentral
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - meshcentral-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
    # Security: MongoDB not exposed externally
    expose:
      - "27017"

  # =============================================================================
  # ECORTEX - Main Application
  # =============================================================================
  meshcentral:
    image: ghcr.io/ylianst/meshcentral:latest
    container_name: meshcentral-server
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      traefik:
        condition: service_started
    environment:
      # Disable dynamic config - we use mounted config.json
      DYNAMIC_CONFIG: "false"
      NODE_ENV: "production"
    volumes:
      # Persistent data volumes
      - meshcentral-data:/opt/meshcentral/meshcentral-data
      - meshcentral-files:/opt/meshcentral/meshcentral-files
      - meshcentral-backups:/opt/meshcentral/meshcentral-backups
      - meshcentral-web:/opt/meshcentral/meshcentral-web
      # Mount production config (generated from template)
      - ./config.json:/opt/meshcentral/meshcentral-data/config.json:ro
    networks:
      - meshcentral-network
    labels:
      - "traefik.enable=true"
      # HTTP router (required for ACME HTTP-01 challenge)
      - "traefik.http.routers.meshcentral-http.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral-http.entrypoints=web"
      # HTTPS router (main web interface)
      - "traefik.http.routers.meshcentral.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral.entrypoints=websecure"
      - "traefik.http.routers.meshcentral.tls.certresolver=letsencrypt"
      - "traefik.http.routers.meshcentral.middlewares=security-headers,ratelimit"
      - "traefik.http.services.meshcentral.loadbalancer.server.port=443"
      - "traefik.http.services.meshcentral.loadbalancer.server.scheme=https"
      - "traefik.http.routers.meshcentral.service=meshcentral"
      - "traefik.http.services.meshcentral.loadbalancer.passHostHeader=true"
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:443/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # FAIL2BAN - Brute force protection (optional but recommended)
  # =============================================================================
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: meshcentral-fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - fail2ban-data:/data
      - traefik-logs:/var/log/traefik:ro
      - ./fail2ban/jail.local:/etc/fail2ban/jail.local:ro
      - ./fail2ban/filter.d:/etc/fail2ban/filter.d:ro
    environment:
      TZ: ${TZ:-America/Chicago}
      F2B_LOG_TARGET: STDOUT
      F2B_LOG_LEVEL: INFO
      F2B_DB_PURGE_AGE: 7d

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  meshcentral-network:
    driver: bridge
    name: meshcentral-network

# =============================================================================
# VOLUMES - All persistent data
# =============================================================================
volumes:
  # Traefik
  traefik-letsencrypt:
    name: meshcentral-traefik-letsencrypt
  traefik-logs:
    name: meshcentral-traefik-logs
  # MongoDB
  mongodb-data:
    name: meshcentral-mongodb-data
  mongodb-config:
    name: meshcentral-mongodb-config
  # eCortex Data
  meshcentral-data:
    name: meshcentral-data
  meshcentral-files:
    name: meshcentral-files
  meshcentral-backups:
    name: meshcentral-backups
  meshcentral-web:
    name: meshcentral-web
  # Fail2ban
  fail2ban-data:
    name: meshcentral-fail2ban-data
